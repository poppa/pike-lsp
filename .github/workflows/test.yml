name: Test

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-24.04

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install Pike
        run: |
          sudo apt-get update
          sudo apt-get install -y pike8.0

      - name: Verify Pike installation
        run: |
          pike --version
          which pike

      - name: Build all packages
        run: bun run build

      - name: Run Pike Bridge tests
        run: cd packages/pike-bridge && bun test

      - name: Run LSP Server tests
        run: cd packages/pike-lsp-server && bun test

      - name: Run LSP smoke tests
        run: cd packages/pike-lsp-server && bun test ./src/tests/smoke.test.ts

      - name: Run integration tests
        run: cd packages/pike-lsp-server && bun test ./dist/tests/integration-tests.js

  pike-test:
    runs-on: ubuntu-24.04

    strategy:
      matrix:
        pike-version: ["8.1116", "latest"]
      fail-fast: false

    continue-on-error: ${{ matrix.pike-version == 'latest' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Pike ${{ matrix.pike-version }}
        run: |
          set -x
          if [ "${{ matrix.pike-version }}" = "8.1116" ]; then
            # Install Pike 8.1116 from official repository
            # Try downloading from Pike's build server if available
            PIKE_VERSION="8.1116"
            PIKE_URL="https://pike.lysator.liu.se/builds/pike-${PIKE_VERSION}.tar.gz"

            # Try apt repository first (may not have 8.1116)
            sudo apt-get update

            # Check if pike8.1116 is available via apt
            if apt-cache show pike${PIKE_VERSION} >/dev/null 2>&1; then
              sudo apt-get install -y pike${PIKE_VERSION}
            else
              # Build from source
              sudo apt-get install -y build-essential libgmp-dev bison flex make
              cd /tmp
              wget "$PIKE_URL" -O pike.tar.gz || {
                echo "Pike ${PIKE_VERSION} not found at ${PIKE_URL}"
                echo "Falling back to pike8.0 from apt"
                sudo apt-get install -y pike8.0
                rm -f pike.tar.gz
              }
              if [ -f pike.tar.gz ]; then
                tar -xzf pike.tar.gz
                cd "pike-${PIKE_VERSION}"
                make
                sudo make install
              fi
            fi
          else
            # Install latest Pike from repository
            sudo apt-get update
            # Try to get latest from pike的开发 PPA or build from latest
            sudo apt-get install -y pike8.0 || {
              # If pike8.0 fails, try to build latest from git
              sudo apt-get install -y build-essential libgmp-dev bison flex make git
              cd /tmp
              git clone https://github.com/pike-lang/pike.git
              cd pike
              make
              sudo make install
            }
          fi

      - name: Verify Pike installation
        run: |
          pike --version
          which pike

      - name: Run Cross-Version Handler Tests
        run: pike test/tests/cross-version-tests.pike

      - name: Run Pike Tests
        run: ./scripts/run-pike-tests.sh

      - name: Cross-version test summary
        if: always()
        run: |
          echo "### Cross-version handler tests : ${{ matrix.pike-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Pike version**: ${{ matrix.pike-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Cross-version tests verify all 12 LSP handlers work correctly" >> $GITHUB_STEP_SUMMARY
          echo "- **Test file**: test/tests/cross-version-tests.pike" >> $GITHUB_STEP_SUMMARY

  build-extension:
    runs-on: ubuntu-24.04
    needs: [test, pike-test]
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Pike
        run: |
          sudo apt-get update
          sudo apt-get install -y pike8.0

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build all packages
        run: bun run build

      - name: Build VSIX
        working-directory: packages/vscode-pike
        run: bun run package

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vscode-pike-extension-${{ github.sha }}
          path: packages/vscode-pike/vscode-pike-*.vsix
          retention-days: 30
          if-no-files-found: error

  vscode-e2e:
    runs-on: ubuntu-24.04
    needs: [test, pike-test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb pike8.0

      - name: Install dependencies
        run: bun install

      - name: Build all packages
        run: bun run build

      - name: Bundle LSP server
        run: cd packages/vscode-pike && bun run bundle-server

      - name: Build VSCode extension tests
        run: cd packages/vscode-pike && bun run build:test

      - name: Run VSCode unit tests
        working-directory: packages/vscode-pike
        run: bun test src/test/mockOutputChannel.test.ts

      - name: Run VSCode LSP Feature Tests
        working-directory: packages/vscode-pike
        run: xvfb-run --auto-servernum bun run test:features

      - name: LSP Feature Test Summary
        if: always()
        run: |
          echo "### LSP Feature Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The LSP feature tests verify:" >> $GITHUB_STEP_SUMMARY
          echo "- Document symbols (outline view)" >> $GITHUB_STEP_SUMMARY
          echo "- Hover (type information)" >> $GITHUB_STEP_SUMMARY
          echo "- Go-to-definition (navigation)" >> $GITHUB_STEP_SUMMARY
          echo "- Completion (autocomplete)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the 'Run VSCode LSP Feature Tests' step above for results." >> $GITHUB_STEP_SUMMARY
