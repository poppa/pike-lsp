#!/bin/sh
# Pre-commit hook: Prevents common anti-patterns from being committed
#
# Checks:
# 1. Placeholder tests (assert.ok(true) without real implementation)
# 2. Development Pike test scripts (test_*.pike, verify_*.pike)
# 3. Temporary analysis reports

set -e

echo "[Pre-commit] Checking for anti-patterns..."

# 1. Check for placeholder tests in staged files
# Look for 'it(' followed by 'assert.ok(true)' but NOT 'it.skip('
PLACEHOLDER_TESTS=$(git diff --cached --name-only --diff-filter=ACM | grep '.test.ts$' | while read f; do
  # Check if file has 'it(' without 'it.skip(' and contains 'assert.ok(true)'
  if grep 'it(' "$f" | grep -v 'it.skip' | grep -q 'assert.ok(true' 2>/dev/null; then
    echo "$f"
  fi
done || true)

if [ -n "$PLACEHOLDER_TESTS" ]; then
  echo "FAILED: Found placeholder tests using assert.ok(true):"
  echo "$PLACEHOLDER_TESTS" | sed 's/^/  - /'
  echo ""
  echo "Placeholder tests should use test.skip() instead:"
  echo "  test.skip('should do something', () => {"
  echo "    assert.ok(true, 'TODO: Implement this test');"
  echo "  });"
  echo ""
  echo "Use 'git commit --no-verify' to bypass (not recommended)."
  exit 1
fi

# 2. Check for development Pike test scripts
PIKE_TEST_SCRIPTS=$(git diff --cached --name-only --diff-filter=A | grep -E 'pike-scripts/(test_|verify_).*\.pike$' || true)

if [ -n "$PIKE_TEST_SCRIPTS" ]; then
  echo "FAILED: Attempting to commit development Pike test scripts:"
  echo "$PIKE_TEST_SCRIPTS" | sed 's/^/  - /'
  echo ""
  echo "These patterns are already in .gitignore:"
  echo "  pike-scripts/test_*.pike"
  echo "  pike-scripts/verify_*.pike"
  echo ""
  echo "Use 'git commit --no-verify' to bypass (not recommended)."
  exit 1
fi

# 3. Check for temporary analysis reports
ANALYSIS_REPORTS=$(git diff --cached --name-only --diff-filter=A | grep -E '(AUTODOC_COVERAGE_ANALYSIS|QA_TEST_REPORT|_ANALYSIS\.md|CODEBASE_REVIEW_REPORT)\.md$' || true)

if [ -n "$ANALYSIS_REPORTS" ]; then
  echo "WARNING: Attempting to commit temporary analysis reports:"
  echo "$ANALYSIS_REPORTS" | sed 's/^/  - /'
  echo ""
  echo "These should be in .git/info/exclude for local reference only."
  echo ""
  echo "To unstage these files:"
  echo "  git reset HEAD <file>"
  echo ""
  echo "Use 'git commit --no-verify' to bypass (not recommended)."
  exit 1
fi

# 4. Fast regression check (Carlini protocol: new commits can't break existing tests)
# Only run if source files were changed (skip for docs-only commits)
CHANGED_SRC=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx|js|pike)$' || true)

if [ -n "$CHANGED_SRC" ]; then
  echo "[Pre-commit] Running fast regression check..."
  if [ -f "scripts/test-agent.sh" ]; then
    bash scripts/test-agent.sh --fast || {
      echo ""
      echo "FAILED: Fast regression check failed. Commit aborted."
      echo "Your changes broke existing tests. Fix them before committing."
      echo "Run 'scripts/test-agent.sh --summary' to see what failed."
      echo ""
      echo "Use 'git commit --no-verify' to bypass (not recommended)."
      exit 1
    }
  fi
fi

# 5. Test quality regression check - placeholder ratio must not increase
# Only check if test files were changed
CHANGED_TESTS=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(test|spec)\.(ts|js)$' || true)

if [ -n "$CHANGED_TESTS" ]; then
  echo "[Pre-commit] Checking test quality regression..."
  NEW_PLACEHOLDERS=0

  for f in $CHANGED_TESTS; do
    [ -f "$f" ] || continue
    # Count new placeholder assertions in staged changes only
    ph=$(git diff --cached -- "$f" | grep '^+' | grep -v '^+++' | grep -oP "assert\.ok\(('Test not implemented|true)" 2>/dev/null | wc -l | tr -d ' ')
    NEW_PLACEHOLDERS=$((NEW_PLACEHOLDERS + ${ph:-0}))
  done

  if [ "$NEW_PLACEHOLDERS" -gt 0 ]; then
    echo "FAILED: Adding $NEW_PLACEHOLDERS new placeholder assertions."
    echo ""
    echo "New tests MUST have real assertions. Do not add assert.ok(true) or"
    echo "assert.ok('Test not implemented...'). Use test.skip() for planned tests:"
    echo ""
    echo "  test.skip('should do something', () => {"
    echo "    // TODO: Implement this test"
    echo "  });"
    echo ""
    echo "Use 'git commit --no-verify' to bypass (not recommended)."
    exit 1
  fi
fi

echo "[Pre-commit] All checks passed!"
