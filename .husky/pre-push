#!/bin/sh
# Pre-push hook: Validates build, Pike compilation, and all tests
# Philosophy: "Green main, not green commits" - allow broken local commits
# Output: Agent-friendly compact output via test-agent.sh (Carlini protocol)

set -e  # Exit on error

# Discover tools: check common locations if not already on PATH
for dir in "$HOME/.bun/bin" /usr/local/bin; do
  [ -d "$dir" ] && export PATH="$dir:$PATH"
done

# Auto-discover Pike if not on PATH
if ! command -v pike >/dev/null 2>&1; then
  for pike_dir in /usr/local/pike/*/bin "$HOME"/*/Pike-*/bin "$HOME"/OpenCode/Pike-*/bin; do
    if [ -x "$pike_dir/pike" ]; then
      export PATH="$pike_dir:$PATH"
      break
    fi
  done
fi

echo "[Pre-push] Running validations..."

# 1. TypeScript build (compact output - only show errors)
echo "[Pre-push] Building all packages..."
BUILD_LOG=$(mktemp)
if ! bun run build > "$BUILD_LOG" 2>&1; then
  echo "FAILED: TypeScript build failed. Push aborted."
  echo "--- Build errors ---"
  grep -iP '(error|TS\d{4})' "$BUILD_LOG" | head -15
  echo "---"
  echo "Full log: $BUILD_LOG"
  exit 1
fi
rm -f "$BUILD_LOG"

# 2. Run full test suite via test-agent.sh (agent-friendly output)
if [ -f "scripts/test-agent.sh" ]; then
  echo "[Pre-push] Running full test suite..."
  bash scripts/test-agent.sh || {
    echo ""
    echo "FAILED: Tests failed. Push aborted."
    echo "Run 'scripts/test-agent.sh --summary' to see what failed."
    exit 1
  }
else
  # Fallback if test-agent.sh doesn't exist
  echo "[Pre-push] test-agent.sh not found, running tests directly..."

  pike -e 'compile_file("pike-scripts/analyzer.pike");' || {
    echo "FAILED: Pike compilation failed. Push aborted."
    exit 1
  }

  if [ -f "packages/pike-lsp-server/src/tests/smoke.test.ts" ]; then
    cd packages/pike-lsp-server && bun test src/tests/smoke.test.ts > /dev/null 2>&1 || {
      echo "FAILED: Smoke tests failed. Push aborted."
      exit 1
    }
    cd ../..
  fi
fi

# 3. Secret detection (optional)
if command -v gitleaks >/dev/null 2>&1; then
  echo "[Pre-push] Scanning for secrets..."
  GITLEAKS_LOG=$(mktemp)
  if ! gitleaks detect --source . --log-opts="origin/main..HEAD" --redact > "$GITLEAKS_LOG" 2>&1; then
    echo "FAILED: Gitleaks detected potential secrets."
    cat "$GITLEAKS_LOG"
    rm -f "$GITLEAKS_LOG"
    exit 1
  fi
  rm -f "$GITLEAKS_LOG"
fi

echo "[Pre-push] All validations passed!"
