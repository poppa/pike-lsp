#!/bin/sh
# Pre-push hook: Validates build, Pike compilation, and smoke tests
# Philosophy: "Green main, not green commits" - allow broken local commits

set -e  # Exit on error

echo "[Pre-push] Running validations..."

# 1. TypeScript builds
echo "[Pre-push] Building all packages..."
bun run build || {
  echo "FAILED: TypeScript build failed. Push aborted."
  echo "Fix build errors or use 'git push --no-verify' to bypass (not recommended)."
  exit 1
}

# 2. Pike compiles
echo "[Pre-push] Checking Pike compilation..."
pike -e 'compile_file("pike-scripts/analyzer.pike");' || {
  echo "FAILED: Pike compilation failed. Push aborted."
  echo "Fix Pike syntax errors or use 'git push --no-verify' to bypass."
  exit 1
}

# 3. Smoke tests (if smoke test exists)
if [ -f "packages/pike-lsp-server/src/tests/smoke.test.ts" ]; then
  echo "[Pre-push] Running smoke tests..."
  cd packages/pike-lsp-server
  bun test src/tests/smoke.test.ts || {
    echo "FAILED: Smoke tests failed. Push aborted."
    echo "Fix failing tests or use 'git push --no-verify' to bypass."
    exit 1
  }
  cd ../..
else
  echo "[Pre-push] Smoke tests not yet available..."
fi

# 4. VSCode E2E feature tests
if [ -f "packages/vscode-pike/src/test/integration/lsp-features.test.ts" ]; then
  echo "[Pre-push] Running VSCode E2E feature tests..."
  cd packages/vscode-pike
  bun run test:features || {
    echo "FAILED: VSCode E2E feature tests failed. Push aborted."
    echo "LSP features (symbols, hover, definition, completion) are broken."
    echo "Fix failing tests or use 'git push --no-verify' to bypass."
    exit 1
  }
  cd ../..
else
  echo "[Pre-push] E2E feature tests not yet available (phase 06-01 pending)..."
fi

# 5. Secret detection (optional)
if command -v gitleaks >/dev/null 2>&1; then
  echo "[Pre-push] Scanning for secrets with gitleaks..."
  # Scan unpushed commits (assuming origin/main is upstream)
  gitleaks detect --source . --log-opts="origin/main..HEAD" --verbose --redact || {
    echo "FAILED: Gitleaks detected potential secrets."
    echo "Review output. If false positive, add to .gitleaksignore."
    exit 1
  }
else
  echo "[Pre-push] gitleaks not found, skipping secret scan."
  echo "Tip: Install gitleaks for local detection: https://github.com/gitleaks/gitleaks"
fi

echo "[Pre-push] All validations passed!"
