---
phase: 01-lean-observability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/pike-lsp-server/src/core/errors.ts
  - packages/pike-lsp-server/src/core/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "LSPError class exists with layer tracking (server/bridge/pike)"
    - "BridgeError extends LSPError with bridge layer"
    - "PikeError extends LSPError with pike layer"
    - "error.chain property returns full error path as string"
    - "Error.cause property is set for error chaining"
    - "Classes are exported from core/index.ts"
  artifacts:
    - path: "packages/pike-lsp-server/src/core/errors.ts"
      provides: "LSPError, BridgeError, PikeError classes"
      min_lines: 60
    - path: "packages/pike-lsp-server/src/core/index.ts"
      provides: "Barrel export for core module"
      contains: "export.*LSPError"
  key_links:
    - from: "packages/pike-lsp-server/src/core/errors.ts"
      to: "native Error.cause"
      via: "extends Error with cause property"
      pattern: "constructor.*cause"
---

<objective>
Create TypeScript error class hierarchy for layered error tracking across the LSP stack.

Purpose: Enable debuggable error chains that show where errors occurred (server, bridge, or Pike layer). When a hover request fails, we need to know if it was a server validation issue, bridge timeout, or Pike subprocess error.

Output: Three error classes (LSPError base, BridgeError, PikeError) with chain tracking
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-lean-observability/01-CONTEXT.md
@.planning/phases/01-lean-observability/01-RESEARCH.md

# Existing patterns
@packages/pike-lsp-server/src/utils/validation.ts
</context>

<tasks>

<task type="auto">
  <name>Create LSPError base class with layer tracking</name>
  <files>packages/pike-lsp-server/src/core/errors.ts</files>
  <action>
Create LSPError class extending Error:
- Constructor takes (message: string, layer: 'server' | 'bridge' | 'pike', cause?: Error)
- Sets this.name = 'LSPError'
- Sets this.layer = layer (public readonly property)
- Sets this.cause = cause (use Error.cause if available, otherwise set on this)
- Implement get chain(): string that walks cause hierarchy and returns "msg1 -> msg2 -> msg3"
- Use proper Error.prototype manipulation for stack traces

IMPORTANT: Use native Error.cause (Node.js 16.9.0+) when available:
```typescript
if (cause && !('cause' in this)) {
  (this as unknown as { cause: Error }).cause = cause;
}
```

DO NOT: Create complex serialization logic - this is for runtime debugging, not IPC
  </action>
  <verify>
  - Compile with `cd packages/pike-lsp-server && pnpm build`
  - Test chain traversal: new LSPError('outer', 'server', new LSPError('inner', 'pike')).chain === 'outer -> inner'
  </verify>
  <done>
LSPError class compiles, extends Error correctly, chain property returns full error path
  </done>
</task>

<task type="auto">
  <name>Create BridgeError and PikeError subclasses</name>
  <files>packages/pike-lsp-server/src/core/errors.ts</files>
  <action>
In the same errors.ts file, add two subclasses after LSPError:

1. BridgeError extends LSPError:
   - Constructor(message: string, cause?: Error)
   - Calls super(message, 'bridge', cause)
   - Sets this.name = 'BridgeError'

2. PikeError extends LSPError:
   - Constructor(message: string, cause?: Error)
   - Calls super(message, 'pike', cause)
   - Sets this.name = 'PikeError'

Both should be exported alongside LSPError.
  </action>
  <verify>
  - Compile with `cd packages/pike-lsp-server && pnpm build`
  - Test: new BridgeError('timeout', new Error('stdio')).layer === 'bridge'
  - Test: new PikeError('compile failed').layer === 'pike'
  </verify>
  <done>
BridgeError and PikeError classes exist, correctly set layer property, compile successfully
  </done>
</task>

<task type="auto">
  <name>Create barrel export for core module</name>
  <files>packages/pike-lsp-server/src/core/index.ts</files>
  <action>
Create packages/pike-lsp-server/src/core/index.ts that re-exports errors:
```typescript
export { LSPError, BridgeError, PikeError } from './errors.js';
```

Note the .js extension - this is an ESM project (see package.json "type": "module").
  </action>
  <verify>
  - Compile with `cd packages/pike-lsp-server && pnpm build`
  - Check dist/core/index.js exists and exports the classes
  </verify>
  <done>
Barrel export allows importing from @pike-lsp/pike-lsp-server/core
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd packages/pike-lsp-server && pnpm build`
2. All three error classes are properly exported
3. Error.chain correctly walks the cause hierarchy
4. Layer property is correctly set on each error type
</verification>

<success_criteria>
- LSPError, BridgeError, PikeError classes exist in dist/core/errors.js
- Importing from '@pike-lsp/pike-lsp-server/core' works
- Error.chain returns readable error path string
- Each error type has correct layer property
</success_criteria>

<output>
After completion, create `.planning/phases/01-lean-observability/01-01-SUMMARY.md`
</output>
