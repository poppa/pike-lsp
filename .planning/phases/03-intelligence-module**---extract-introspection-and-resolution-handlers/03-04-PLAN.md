---
phase: 03-intelligence-module
plan: 04
type: execute
wave: 4
depends_on: [03-01, 03-02, 03-03]
files_modified:
  - test/tests/intelligence-tests.pike
  - pike-scripts/analyzer.pike
autonomous: false

must_haves:
  truths:
    - "Integration tests pass for handle_introspect with valid Pike code"
    - "Integration tests pass for handle_introspect with invalid code (returns diagnostics)"
    - "Integration tests pass for handle_resolve with local modules"
    - "Integration tests pass for handle_resolve with stdlib modules"
    - "Integration tests pass for handle_resolve_stdlib"
    - "Integration tests pass for handle_get_inherited"
    - "analyzer.pike updated to delegate to Intelligence.pike for all four handlers"
    - "Tests use VSCode console format (for test runner integration)"
    - "Test coverage includes error paths (cache misses, resolve failures)"
  artifacts:
    - path: "test/tests/intelligence-tests.pike"
      provides: "Integration tests for Intelligence.pike"
      min_lines: 400
      contains: "test_introspect", "test_resolve", "test_resolve_stdlib", "test_get_inherited"
    - path: "pike-scripts/analyzer.pike"
      provides: "Updated analyzer delegating to Intelligence.pike"
      contains: "LSP.Intelligence"
  key_links:
    - from: "test/tests/intelligence-tests.pike"
      to: "pike-scripts/LSP.pmod/Intelligence.pike"
      via: "master()->resolv('LSP.Intelligence')->Intelligence()"
      pattern: "LSP\\.Intelligence"
    - from: "pike-scripts/analyzer.pike"
      to: "pike-scripts/LSP.pmod/Intelligence.pike"
      via: "intelligence_instance->method_name(...)"
      pattern: "intelligence_instance"
---

<objective>
Write integration tests for Intelligence.pike and update analyzer.pike to delegate.

Purpose: Verify all four Intelligence handlers work correctly via integration tests, then update analyzer.pike to use the new class.
Output: Comprehensive test suite and analyzer.pike refactored to use Intelligence.pike.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-intelligence-module**---extract-introspection-and-resolution-handlers/03-CONTEXT.md
@.planning/phases/03-intelligence-module**---extract-introspection-and-resolution-handlers/03-RESEARCH.md
@.planning/phases/03-intelligence-module**---extract-introspection-and-resolution-handlers/03-01-SUMMARY.md
@.planning/phases/03-intelligence-module**---extract-introspection-and-resolution-handlers/03-02-SUMMARY.md
@.planning/phases/03-intelligence-module**---extract-introspection-and-resolution-handlers/03-03-SUMMARY.md
@test/tests/parser-tests.pike
@pike-scripts/analyzer.pike
@pike-scripts/LSP.pmod/Intelligence.pike
</context>

<tasks>

<task type="auto">
  <name>Create integration tests for Intelligence.pike</name>
  <files>test/tests/intelligence-tests.pike</files>
  <action>
Create test/tests/intelligence-tests.pike with comprehensive integration tests:

1. File structure following parser-tests.pike pattern:
   - Test module setup (add_module_path)
   - Intelligence class instantiation
   - VSCode console output format
   - Summary statistics (passed, failed, total)

2. Test fixtures directory: test/fixtures/intelligence/
   - simple-class.pike - Basic class with methods
   - inherit-sample.pike - Class with inheritance
   - stdlib-test.pike - Code using stdlib functions

3. Test cases (minimum 15 tests):

   **handle_introspect tests (4):**
   - test_introspect_valid_code: Compiles successfully, returns symbols
   - test_introspect_syntax_error: Returns diagnostics for invalid code
   - test_introspect_extracts_functions: Functions extracted with signatures
   - test_introspect_extracts_variables: Variables extracted with types

   **handle_resolve tests (4):**
   - test_resolve_local_pike: Resolves .module.pike to file path
   - test_resolve_local_pmod_dir: Resolves .module.pmod directory
   - test_resolve_stdlib_module: Resolves stdlib module (e.g., "Array")
   - test_resolve_not_found: Returns exists:0 for missing module

   **handle_resolve_stdlib tests (4):**
   - test_resolve_stdlib_array: Resolves and caches Array module
   - test_resolve_stdlib_cache_hit: Second call hits cache
   - test_resolve_stdlib_with_docs: Documentation parsed and merged
   - test_resolve_stdlib_not_found: Returns found:0 for bad module

   **handle_get_inherited tests (3):**
   - test_get_inherited_single_parent: Gets members from single parent
   - test_get_inherited_multiple_parents: Aggregates from multiple parents
   - test_get_inherited_no_inherit: Returns empty for class without inherits

4. VSCode console format:
   ```
   [test_name] PASS/FAIL
   ```
   At end: `X passed, Y failed, Z total`

5. Use assertions with clear messages:
   ```pike
   if (!result->result->success) {
       test_failed("test_introspect_valid_code", "Expected success=1");
   }
   ```

Note: Follow parser-tests.pike format for consistency.
  </action>
  <verify>
pike test/tests/intelligence-tests.pike 2>&1 | head -50
  </verify>
  <done>
intelligence-tests.pike exists, runs tests, produces VSCode console output
  </done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Complete integration test suite for Intelligence.pike (15+ tests)</what-built>
  <how-to-verify>
1. Run tests: `pike test/tests/intelligence-tests.pike`
2. Check output shows test names with PASS/FAIL status
3. Check summary shows all tests passing (or note any failures)
4. Review test coverage - all four handlers tested with success and error paths
5. Verify VSCode console format is correct (matches parser-tests.pike)
  </how-to-verify>
  <resume-signal>Type "approved" if tests pass, or describe failures to fix</resume-signal>
</task>

<task type="auto">
  <name>Update analyzer.pike to delegate to Intelligence.pike</name>
  <files>pike-scripts/analyzer.pike</files>
  <action>
Update pike-scripts/analyzer.pike to delegate intelligence handlers to Intelligence.pike:

1. Add Intelligence class instantiation at module level (after Parser setup):
   ```pike
   // Import Intelligence class
   program IntelligenceClass = master()->resolv("LSP.Intelligence")->Intelligence;
   object intelligence_instance = IntelligenceClass();
   ```

2. Update handle_introspect (around line 1156):
   - Replace entire function body with delegation:
     ```pike
     protected mapping handle_introspect(mapping params) {
         mixed err = catch {
             return intelligence_instance->handle_introspect(params);
         };
         return ([
             "error": ([
                 "code": -32000,
                 "message": describe_error(err)
             ])
         ]);
     }
     ```

3. Update handle_resolve (around line 226):
   - Same delegation pattern

4. Update handle_resolve_stdlib (around line 1213):
   - Same delegation pattern

5. Update handle_get_inherited (around line 1497):
   - Same delegation pattern

6. Keep helper functions that may still be used elsewhere:
   - get_module_path (check if used by other handlers like analyze_uninitialized)
   - introspect_program (check usage)
   - parse_autodoc, merge_documentation, etc. (check usage)

7. DO NOT remove:
   - handle_parse, handle_tokenize, handle_compile (delegated to Parser)
   - handle_find_occurrences, handle_analyze_uninitialized, handle_get_completion_context (Phase 4)
   - handle_batch_parse, handle_set_debug (current)

Use `grep -n "introspect_program\|get_module_path\|parse_autodoc" analyzer.pike` to verify removal safety.
  </action>
  <verify>
grep -E "LSP\.Intelligence|intelligence_instance->" pike-scripts/analyzer.pike
  </verify>
  <done>
analyzer.pike delegates all four handlers to Intelligence.pike instance, old handler implementations removed (if safe)
  </done>
</task>

</tasks>

<verification>
1. Test file exists: `ls -la test/tests/intelligence-tests.pike`
2. Tests run: `pike test/tests/intelligence-tests.pike` produces output
3. analyzer.pike has Intelligence delegation: `grep "LSP.Intelligence" pike-scripts/analyzer.pike`
4. All four handlers delegate: `grep "intelligence_instance->handle_" pike-scripts/analyzer.pike | wc -l` equals 4
</verification>

<success_criteria>
1. 15+ integration tests covering all four handlers
2. Tests use VSCode console format
3. analyzer.pike delegates to Intelligence.pike for all four handlers
4. Integration tests pass (all tests show PASS)
5. No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/03-intelligence-module**---extract-introspection-and-resolution-handlers/03-04-SUMMARY.md`
</output>
