---
phase: 05-pike-reorganization
plan: 04
type: execute
wave: 2
depends_on: ["05-03"]
files_modified:
  - pike-scripts/LSP.pmod/Analysis.pmod/Completions.pike
  - pike-scripts/LSP.pmod/Analysis.pmod/Variables.pike
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Completions class contains handle_get_completion_context handler"
    - "Variables class contains handle_find_occurrences handler"
    - "Occurernces is part of Variables.pike (not separate file)"
    - "Both classes use create(object ctx) constructor pattern"
    - "Both classes use helpers from module.pmod"
  artifacts:
    - path: "pike-scripts/LSP.pmod/Analysis.pmod/Completions.pike"
      provides: "Completions class with completion context analysis"
      min_lines: 120
    - path: "pike-scripts/LSP.pmod/Analysis.pmod/Variables.pike"
      provides: "Variables class with find occurrences and position helpers"
      min_lines: 100
  key_links:
    - from: "pike-scripts/LSP.pmod/Analysis.pmod/Completions.pike"
      to: "pike-scripts/LSP.pmod/Analysis.pmod/module.pmod"
      via: "get_char_pos_in_line for position calculation"
      pattern: "get_char_pos_in_line"
    - from: "pike-scripts/LSP.pmod/Analysis.pmod/Variables.pike"
      to: "pike-scripts/LSP.pmod/Analysis.pmod/module.pmod"
      via: "is_identifier for token filtering"
      pattern: "is_identifier"
---

<objective>
Create Completions.pike and Variables.pike classes to complete the Analysis.pmod split.

Purpose: Split the remaining Analysis.pike handlers into Completions.pike (completion context analysis) and Variables.pike (find occurrences, keeping Occurrences-related logic together per v2 design).
Output: Analysis.pmod with 4 files total: module.pmod, Diagnostics.pike, Completions.pike, Variables.pike
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Codebase intelligence
@.planning/intel/summary.md

# Phase context
@.planning/phases/05-pike-reorganization/05-CONTEXT.md
@.planning/phases/05-pike-reorganization/05-RESEARCH.md
@.planning/phases/05-pike-reorganization/05-03-SUMMARY.md

# Source files to split
@pike-scripts/LSP.pmod/Analysis.pike
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Completions.pike with Completions class</name>
  <files>pike-scripts/LSP.pmod/Analysis.pmod/Completions.pike</files>
  <action>
    Create Completions.pike with class Completions that contains:

    1. Private object context field
    2. void create(object ctx) constructor

    3. Mapping handler:
       - handle_get_completion_context(mapping params) - Analyze code at cursor for completion context

    Handler implementation:
    - Uses Parser.Pike.split() and Parser.Pike.tokenize() for tokenization
    - Finds token at or just before cursor position
    - Scans backwards to find access operators (->, ., ::)
    - Returns context type: "none", "global", "identifier", "member_access", "scope_access"
    - Returns objectName, prefix, operator fields

    Handler pattern:
    - Wrap handler body in catch { ... }
    - On error: Return default "none" context (graceful degradation)
    - Use werror for error logging but don't crash
    - Use LSP.Compat.trim_whites() for string operations

    Use helper from module.pmod:
    - get_char_pos_in_line() or implement locally for position calculation

    DO NOT include (goes in Variables.pike):
    - handle_find_occurrences
    - get_char_position (occurrences position helper)
  </action>
  <verify>pike -e 'master()->add_module_path("pike-scripts"); mixed m = master()->resolv("LSP.Analysis.Completions"); if (programp(m)) { werror("OK\n"); } else { werror("FAIL\n"); exit(1); }'</verify>
  <done>Completions class with handle_get_completion_context method</done>
</task>

<task type="auto">
  <name>Task 2: Create Variables.pike with Variables class</name>
  <files>pike-scripts/LSP.pmod/Analysis.pmod/Variables.pike</files>
  <action>
    Create Variables.pike with class Variables that contains:

    1. Private object context field
    2. void create(object ctx) constructor

    3. Mapping handler:
       - handle_find_occurrences(mapping params) - Find all identifier occurrences

    4. Protected helper:
       - int get_char_position(string code, int line_no, string token_text) - Get character position

    Handler implementation:
    - Uses Parser.Pike.split() and Parser.Pike.tokenize() for tokenization
    - Filters out keywords (array of 40+ Pike keywords)
    - Identifies identifiers starting with letter/underscore
    - Returns occurrences array with: text, line, character

    Handler pattern:
    - Wrap handler body in catch { ... }
    - On error: return LSP.module.LSPError(-32000, describe_error(err))->to_response()
    - Use LSP.Compat.trim_whites() for string operations

    Note: Per v2 design decision, Occurrences stays in Variables.pike (not separate file)
    because finding occurrences is fundamentally about tracking variable references.

    Use helper from module.pmod:
    - is_identifier() for validating identifier tokens

    DO NOT include (goes in other files):
    - handle_analyze_uninitialized (Diagnostics.pike)
    - handle_get_completion_context (Completions.pike)
  </action>
  <verify>pike -e 'master()->add_module_path("pike-scripts"); mixed m = master()->resolv("LSP.Analysis.Variables"); if (programp(m)) { werror("OK\n"); } else { werror("FAIL\n"); exit(1); }'</verify>
  <done>Variables class with handle_find_occurrences method</done>
</task>

<task type="auto">
  <name>Task 3: Verify all Analysis classes load and create summary</name>
  <files></files>
  <action>
    Verify that all four Analysis classes load correctly:

    Verification command:
    pike -e '
      master()->add_module_path("pike-scripts");
      mixed mod = master()->resolv("LSP.Analysis");
      if (!mod) { werror("FAIL: Module not loaded\n"); exit(1); }
      werror("OK: LSP.Analysis loaded\n");

      array(string) classes = ({"Diagnostics", "Completions", "Variables"});
      foreach (classes, string cls_name) {
        mixed cls = mod[cls_name];
        if (!programp(cls)) {
          werror("FAIL: %s class not found\n", cls_name);
          exit(1);
        }
        werror("OK: %s class found\n", cls_name);
      }

      // Verify module.pmod functions
      array(string) funcs = ({"is_type_keyword", "is_identifier", "find_next_token",
                              "find_matching_brace", "try_parse_declaration",
                              "extract_function_params"});
      foreach (funcs, string func_name) {
        if (!functionp(mod[func_name])) {
          werror("FAIL: %s function not found\n", func_name);
          exit(1);
        }
      }
      werror("OK: module.pmod functions accessible\n");
    '

    Create summary at .planning/phases/05-pike-reorganization/05-04-SUMMARY.md
  </action>
  <verify>All classes load, module.pmod functions accessible</verify>
  <done>Analysis.pmod complete with 4 files</done>
</task>

</tasks>

<verification>
## Module Loading Tests

```bash
pike -e '
  master()->add_module_path("pike-scripts");
  mixed mod = master()->resolv("LSP.Analysis");
  if (!mod) { exit(1); }
  foreach (({"Diagnostics", "Completions", "Variables"}), string cls) {
    if (!programp(mod[cls])) { werror("Missing: %s\n", cls); exit(1); }
  }
  werror("PASS: All Analysis classes loaded\n");
'
```

## File Structure Verification

- [ ] pike-scripts/LSP.pmod/Analysis.pmod/module.pmod
- [ ] pike-scripts/LSP.pmod/Analysis.pmod/Diagnostics.pike
- [ ] pike-scripts/LSP.pmod/Analysis.pmod/Completions.pike
- [ ] pike-scripts/LSP.pmod/Analysis.pmod/Variables.pike
</verification>

<success_criteria>
1. Completions.pike exists with handle_get_completion_context
2. Variables.pike exists with handle_find_occurrences
3. All classes use create(object ctx) constructor
4. All handlers use catch/error handling pattern
5. Occurrences is in Variables.pike (not separate file)
6. Original Analysis.pike still exists (backup, not deleted yet)
</success_criteria>

<output>
After completion, create `.planning/phases/05-pike-reorganization/05-04-SUMMARY.md`
</output>
