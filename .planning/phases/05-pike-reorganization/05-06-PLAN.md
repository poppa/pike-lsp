---
phase: 05-pike-reorganization
plan: 06
type: execute
wave: 4
depends_on: ["05-05"]
files_modified:
  - test/tests/module-load-tests.pike
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Module loading tests verify LSP.Intelligence.* and LSP.Analysis.* classes"
    - "E2E smoke test passes (pike compiles, introspect works)"
    - "All handlers still work through the new structure"
    - "Line count reduction confirmed"
  artifacts:
    - path: "test/tests/module-load-tests.pike"
      provides: "Updated module loading tests for new structure"
      min_lines: 50
  key_links:
    - from: "test/tests/module-load-tests.pike"
      to: "pike-scripts/LSP.pmod/Intelligence.pmod/*"
      via: "Tests verify all new classes load correctly"
      pattern: "LSP\.Intelligence\.(Introspection|Resolution|TypeAnalysis)"
    - from: "test/tests/module-load-tests.pike"
      to: "pike-scripts/LSP.pmod/Analysis.pmod/*"
      via: "Tests verify all new classes load correctly"
      pattern: "LSP\.Analysis\.(Diagnostics|Completions|Variables)"
---

<objective>
Update module loading tests and run E2E smoke test to verify the Pike reorganization is complete and functional.

Purpose: Ensure the new modular structure is fully tested and end-to-end functionality works, completing Phase 5 and the v2 milestone.
Output: Updated tests passing, E2E verification complete, Phase 5 ready to close
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Codebase intelligence
@.planning/intel/summary.md

# Phase context
@.planning/phases/05-pike-reorganization/05-CONTEXT.md
@.planning/phases/05-pike-reorganization/05-RESEARCH.md
@.planning/phases/05-pike-reorganization/05-05-SUMMARY.md

# Files to modify
@test/tests/module-load-tests.pike
@pike-scripts/analyzer.pike
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update module-load-tests.pike for new structure</name>
  <files>test/tests/module-load-tests.pike</files>
  <action>
    Update test/tests/module-load-tests.pike to verify the new modular structure.

    Add new test function test_modular_intelligence_structure() to verify:
    1. LSP.Intelligence module loads
    2. LSP.Intelligence.Introspection class exists
    3. LSP.Intelligence.Resolution class exists
    4. LSP.Intelligence.TypeAnalysis class exists
    5. LSP.Intelligence.Intelligence class exists (backward compat)

    Add new test function test_modular_analysis_structure() to verify:
    1. LSP.Analysis module loads
    2. LSP.Analysis.Diagnostics class exists
    3. LSP.Analysis.Completions class exists
    4. LSP.Analysis.Variables class exists
    5. LSP.Analysis.Analysis class exists (backward compat)

    Update existing test_critical_exports() to also check:
    - LSP.Intelligence.Introspection class
    - LSP.Intelligence.Resolution class
    - LSP.Intelligence.TypeAnalysis class
    - LSP.Analysis.Diagnostics class
    - LSP.Analysis.Completions class
    - LSP.Analysis.Variables class

    Add to main() test runner:
    run_test(test_modular_intelligence_structure, "Modular Intelligence structure");
    run_test(test_modular_analysis_structure, "Modular Analysis structure");

    Pattern for new tests:
    ```pike
    void test_modular_intelligence_structure() {
        mixed mod = master()->resolv("LSP.Intelligence");
        if (!mod) error("LSP.Intelligence module not found\n");

        array(string) classes = ({
            "Introspection", "Resolution", "TypeAnalysis", "Intelligence"
        });

        foreach (classes, string cls_name) {
            mixed cls = mod[cls_name];
            if (!cls) error("LSP.Intelligence.%s not found\n", cls_name);
            if (!programp(cls)) error("LSP.Intelligence.%s is not a class\n", cls_name);
        }
    }
    ```

    Error handling pattern in tests: Use error() to fail tests, not LSPError
    (tests are internal validation, not LSP protocol responses)
  </action>
  <verify>pike test/tests/module-load-tests.pike runs and passes</verify>
  <done>module-load-tests.pike updated with new structure tests</done>
</task>

<task type="auto">
  <name>Task 2: Run E2E smoke test to verify LSP functionality</name>
  <files></files>
  <action>
    Run the mandatory E2E verification from CLAUDE.md before committing.

    Step 1: Verify Pike compiles
    pike -e 'compile_file("pike-scripts/analyzer.pike");'

    Step 2: Test introspect through the analyzer
    echo '{"jsonrpc":"2.0","id":1,"method":"introspect","params":{"code":"int x;","filename":"test.pike"}}' \
      | timeout 5 pike pike-scripts/analyzer.pike 2>&1

    Expected: JSON response with "result" containing symbols, not timeout or error

    Step 3: Run module loading tests
    pike test/tests/module-load-tests.pike

    Expected: All tests pass

    Step 4: Verify line counts are reduced
    wc -l pike-scripts/LSP.pmod/Intelligence.pike
    wc -l pike-scripts/LSP.pmod/Analysis.pike
    wc -l pike-scripts/LSP.pmod/Intelligence.pmod/*.pike
    wc -l pike-scripts/LSP.pmod/Intelligence.pmod/*.pmod
    wc -l pike-scripts/LSP.pmod/Analysis.pmod/*.pike
    wc -l pike-scripts/LSP.pmod/Analysis.pmod/*.pmod

    Expected:
    - Intelligence.pike: ~100 lines (down from 1660)
    - Analysis.pike: ~80 lines (down from 1191)
    - Each .pike file in .pmod: 100-500 lines

    Step 5: Verify all handler methods work through delegation
    Test that each handler forwards correctly to specialized classes.
  </action>
  <verify>
    1. Pike compiles without errors
    2. Introspect returns valid JSON with symbols
    3. Module loading tests pass
    4. Line counts confirm reduction
  </verify>
  <done>E2E smoke test passes, Pike reorganization complete</done>
</task>

</tasks>

<verification>
## E2E Smoke Test (MANDATORY before commit)

```bash
# 1. Pike compiles
pike -e 'compile_file("pike-scripts/analyzer.pike");'

# 2. Introspect works
echo '{"jsonrpc":"2.0","id":1,"method":"introspect","params":{"code":"int x;","filename":"test.pike"}}' \
  | timeout 5 pike pike-scripts/analyzer.pike

# 3. Module tests pass
pike test/tests/module-load-tests.pike
```

## Line Count Verification

```bash
# Should show significant reduction
wc -l pike-scripts/LSP.pmod/Intelligence.pike
wc -l pike-scripts/LSP.pmod/Analysis.pike
wc -l pike-scripts/LSP.pmod/Intelligence.pmod/*.pike
wc -l pike-scripts/LSP.pmod/Analysis.pmod/*.pike
```

## Final Structure

- [ ] pike-scripts/LSP.pmod/Intelligence.pike (~100 lines, delegating)
- [ ] pike-scripts/LSP.pmod/Intelligence.pmod/module.pmod
- [ ] pike-scripts/LSP.pmod/Intelligence.pmod/Introspection.pike
- [ ] pike-scripts/LSP.pmod/Intelligence.pmod/Resolution.pike
- [ ] pike-scripts/LSP.pmod/Intelligence.pmod/TypeAnalysis.pike
- [ ] pike-scripts/LSP.pmod/Analysis.pike (~80 lines, delegating)
- [ ] pike-scripts/LSP.pmod/Analysis.pmod/module.pmod
- [ ] pike-scripts/LSP.pmod/Analysis.pmod/Diagnostics.pike
- [ ] pike-scripts/LSP.pmod/Analysis.pmod/Completions.pike
- [ ] pike-scripts/LSP.pmod/Analysis.pmod/Variables.pike
</verification>

<success_criteria>
1. Intelligence.pike: 1660 -> ~100 lines (94% reduction)
2. Analysis.pike: 1191 -> ~80 lines (93% reduction)
3. LSP.Intelligence.* classes all load via master()->resolv()
4. LSP.Analysis.* classes all load via master()->resolv()
5. E2E smoke test passes (introspect returns data)
6. Module loading tests pass with new structure
7. Related logic stays together (StdlibResolver in Resolution, Occurrences in Variables)
</success_criteria>

<output>
After completion, create `.planning/phases/05-pike-reorganization/05-06-SUMMARY.md`

This is the final plan of Phase 5. Upon completion:
1. Update ROADMAP.md to mark Phase 5 complete
2. Update STATE.md with final velocity metrics
3. Mark v2 milestone complete (all 5 phases done)
</output>
