---
phase: 09-implement-pike-version-detection
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - packages/pike-bridge/src/bridge.ts
  - packages/pike-lsp-server/src/services/bridge-manager.ts
autonomous: true

must_haves:
  truths:
    - "PikeBridge has getVersionInfo method using RPC"
    - "BridgeManager fetches version on startup"
    - "BridgeManager.getHealth() returns cached version"
  artifacts:
    - path: "packages/pike-bridge/src/bridge.ts"
      provides: "getVersionInfo RPC wrapper"
    - path: "packages/pike-lsp-server/src/services/bridge-manager.ts"
      provides: "version caching and absolute path resolution"
  key_links:
    - from: "BridgeManager.start"
      to: "PikeBridge.getVersionInfo"
      via: "async call on startup"
---

<objective>
Update the TypeScript bridge and manager to use the new get_version RPC for robust version detection and caching.

Purpose: Enable accurate version reporting in health checks without overhead.
Output: Updated PikeBridge and BridgeManager.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/09-implement-pike-version-detection/09-01-SUMMARY.md
@packages/pike-bridge/src/bridge.ts
@packages/pike-lsp-server/src/services/bridge-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getVersionInfo to PikeBridge</name>
  <files>packages/pike-bridge/src/bridge.ts</files>
  <action>
    Add a getVersionInfo() method to PikeBridge that calls the 'get_version' RPC method.
    It should return a promise resolving to an object with the version details defined in 09-01.
    Add proper error handling for when the method is not found (fallback to null or Unknown).
  </action>
  <verify>
    npm test in packages/pike-bridge (after adding a test case if possible)
  </verify>
  <done>
    PikeBridge can query version via RPC.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement version caching in BridgeManager</name>
  <files>packages/pike-lsp-server/src/services/bridge-manager.ts</files>
  <action>
    1. Update BridgeManager to have a private 'cachedVersion' property.
    2. In start(), call bridge.getVersionInfo() and store the result.
    3. Resolve the absolute path of options.pikePath using fs.realpathSync (or similar) to include in the version string.
    4. Update getHealth() to return the cached version + path.
  </action>
  <verify>
    Check unit tests or smoke tests for BridgeManager.
  </verify>
  <done>
    BridgeManager reports actual Pike version and path in health status.
  </done>
</task>

</tasks>

<verification>
Run smoke tests to ensure bridge still starts and health info is populated.
</verification>

<success_criteria>
BridgeManager reports non-null pikeVersion in getHealth() after start.
</success_criteria>

<output>
After completion, create `.planning/phases/09-implement-pike-version-detection/09-02-SUMMARY.md`
</output>
