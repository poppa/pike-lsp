---
phase: 09-version-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [pike-scripts/analyzer.pike, packages/pike-bridge/src/types.ts]
autonomous: true

must_haves:
  truths:
    - "The analyzer script can respond to 'get_version' requests"
    - "TypeScript types exist for the version response"
  artifacts:
    - path: "pike-scripts/analyzer.pike"
      provides: "get_version RPC handler"
    - path: "packages/pike-bridge/src/types.ts"
      provides: "PikeVersion interface"
  key_links:
    - from: "analyzer.pike"
      to: "Pike runtime"
      via: "__REAL_VERSION__ and __REAL_BUILD__"
---

<objective>
Add the 'get_version' JSON-RPC method to the analyzer script and define the response types in the bridge.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@pike-scripts/analyzer.pike
@packages/pike-bridge/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add get_version to analyzer.pike</name>
  <files>pike-scripts/analyzer.pike</files>
  <action>
    Add a new handler to the `HANDLERS` mapping in `main()` that returns structured version information.
    Use `LSP.Compat->pike_version()` and Pike constants.

    Implementation:
    ```pike
    "get_version": lambda(mapping params, object ctx) {
        array(int) ver = master()->resolv("LSP.Compat")->pike_version();
        return ([
            "version": sprintf("%d.%d.%d", ver[0], ver[1], ver[2]),
            "real_version": __REAL_VERSION__,
            "build": __REAL_BUILD__,
            "display": version()
        ]);
    },
    ```
  </action>
  <verify>
    Run: `echo '{"jsonrpc":"2.0","id":1,"method":"get_version","params":{}}' | pike pike-scripts/analyzer.pike`
    Verify it returns a JSON object with version fields.
  </verify>
  <done>Analyzer returns version info via RPC</done>
</task>

<task type="auto">
  <name>Task 2: Define PikeVersion types</name>
  <files>packages/pike-bridge/src/types.ts</files>
  <action>
    - Add a `PikeVersion` interface that matches the analyzer output.
    - Add `get_version` to the `method` union in `PikeRequest`.

    Types:
    ```typescript
    export interface PikeVersion {
        version: string;
        real_version: number;
        build: number;
        display: string;
    }
    ```
  </action>
  <verify>Check that the file compiles without errors: `cd packages/pike-bridge && pnpm build`</verify>
  <done>PikeVersion types are defined</done>
</task>

</tasks>

<verification>
Check that analyzer.pike still compiles: `pike -e 'compile_file("pike-scripts/analyzer.pike");'`
Verify RPC response manually.
</verification>

<success_criteria>
Analyzer script responds to get_version method with correct Pike version data.
</success_criteria>

<output>
After completion, create `.planning/phases/09-version-detection/09-01-SUMMARY.md`
</output>
