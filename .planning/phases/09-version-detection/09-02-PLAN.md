---
phase: 09-version-detection
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified: [packages/pike-bridge/src/bridge.ts, packages/pike-lsp-server/src/services/bridge-manager.ts]
autonomous: true

must_haves:
  truths:
    - "PikeBridge has a method to fetch version via RPC"
    - "BridgeManager caches the version on startup"
  artifacts:
    - path: "packages/pike-bridge/src/bridge.ts"
      provides: "getRpcVersion method"
    - path: "packages/pike-lsp-server/src/services/bridge-manager.ts"
      provides: "version caching logic"
  key_links:
    - from: "BridgeManager"
      to: "PikeBridge.getRpcVersion"
      via: "initialization call"
---

<objective>
Implement the bridge-side logic to fetch and cache the Pike version during initialization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-version-detection/09-01-SUMMARY.md
@packages/pike-bridge/src/bridge.ts
@packages/pike-lsp-server/src/services/bridge-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getRpcVersion to PikeBridge</name>
  <files>packages/pike-bridge/src/bridge.ts</files>
  <action>
    Implement `getRpcVersion(): Promise<PikeVersion>` using `sendRequest<PikeVersion>('get_version', {})`.
    This ensures we get the version of the interpreter actually running the script.
    Handle potential RPC errors by throwing a `PikeError`.
  </action>
  <verify>Run existing tests to ensure no regressions: `cd packages/pike-bridge && pnpm test`</verify>
  <done>PikeBridge can fetch version via RPC</done>
</task>

<task type="auto">
  <name>Task 2: Implement version detection in BridgeManager</name>
  <files>packages/pike-lsp-server/src/services/bridge-manager.ts</files>
  <action>
    - Add a `private cachedVersion: string | null = null` field.
    - Add a private `detectVersion()` method that calls `bridge.getRpcVersion()`.
    - Format the version string (e.g., just the version number).
    - Update `start()` to call `detectVersion()` after the bridge is started.
    - Update `getHealth()` to return `this.cachedVersion`.
    - Log the detected version on successful detection.
  </action>
  <verify>Check that getHealth() now includes a non-null version after bridge is started.</verify>
  <done>BridgeManager caches and reports Pike version</done>
</task>

</tasks>

<verification>
Verify bridge-manager.ts compiles and tests pass.
</verification>

<success_criteria>
BridgeManager successfully fetches and caches the Pike version from the running subprocess.
</success_criteria>

<output>
After completion, create `.planning/phases/09-version-detection/09-02-SUMMARY.md`
</output>
