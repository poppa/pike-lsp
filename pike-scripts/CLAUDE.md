# Pike Scripts - LSP Analyzer

## CRITICAL: Architecture Invariants

### Stdin Reading - DO NOT CHANGE

The main loop in `analyzer.pike` **MUST** use line-by-line reading:

```pike
// CORRECT - line-by-line loop
while ((line = Stdio.stdin.gets())) {
    // process line...
}
```

**NEVER** use `Stdio.stdin->read()` which waits for EOF and breaks IPC:

```pike
// WRONG - blocks until stdin closes, breaks bridge communication
string data = Stdio.stdin->read();  // DO NOT USE
```

This broke the LSP in Jan 2026 and required manual debugging to fix.

### Pike Version Compatibility

- Use `String.trim_all_whites()` not `String.trim()` (not available in Pike 8.0)
- Test with Pike 8.0.x (the target version)

## Mandatory E2E Testing

Before committing changes to pike-scripts/, you MUST verify:

### 1. Pike Bridge Communication

```bash
# Test introspect works through the bridge
node -e "
import('./packages/pike-bridge/dist/index.js').then(async ({PikeBridge}) => {
  const bridge = new PikeBridge();
  await bridge.start();
  const result = await bridge.introspect('class Foo { int x; }', '/tmp/test.pike');
  console.log('Introspect:', result.success ? 'OK' : 'FAILED');
  await bridge.stop();
});
"
```

### 2. LSP Document Symbols

```bash
# Test that document symbols return data (not null)
# See /tmp/test-lsp-symbols.js for full test
```

### 3. LSP Hover

```bash
# Test that hover returns content (not null)
# See /tmp/test-lsp-hover.js for full test
```

## File Structure

- `analyzer.pike` - Main entry point, JSON-RPC router
- `LSP.pmod/` - Module directory
  - `Parser.pike` - Parsing and tokenization
  - `Intelligence.pike` - Introspection, resolution, inheritance
  - `Analysis.pike` - Diagnostics, completions, occurrences
  - `Cache.pmod` - Caching utilities
  - `Compat.pmod` - Pike version compatibility

## Testing Commands

```bash
# Verify Pike script compiles
pike -e 'compile_file("pike-scripts/analyzer.pike");'

# Direct analyzer test
echo '{"jsonrpc":"2.0","id":1,"method":"parse","params":{"code":"int x;"}}' | pike pike-scripts/analyzer.pike

# Full test suite
pnpm test
```

<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Jan 19, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #3750 | 8:23 PM | ðŸŸ£ | Created Parser.pike class with parse_request method | ~287 |
| #3746 | 8:15 PM | ðŸ”µ | Phase 02 Plan 02 Created for Remaining Parser Methods | ~384 |
| #3745 | " | ðŸ”µ | Phase 02 Plan 01 Created for Parser.pike Extraction | ~440 |
| #3742 | 8:13 PM | ðŸ”µ | Phase 02 Research Document Created | ~452 |
| #3737 | 8:11 PM | ðŸ”µ | Source Analyzer Files Located | ~181 |
| #3536 | 5:55 PM | ðŸ”µ | Pike Modularization Research Completed | ~211 |
| #3529 | 5:54 PM | ðŸ”µ | Research document created: Pike stdlib module patterns for LSP.pmod refactoring | ~497 |
| #3516 | 5:53 PM | ðŸ”µ | Analyzer implements uninitialized variable detection with control flow analysis | ~414 |
| #3515 | " | ðŸ”µ | Confirmed String.trim_whites() Usage in analyzer.pike | ~219 |
| #3512 | " | ðŸ”µ | Analyzer.pike contains function extraction, tokenization, inheritance, and introspection logic | ~441 |
| #3502 | 5:52 PM | ðŸ”µ | Pike analyzer script implements preprocessor directive handling for conditional compilation | ~404 |
| #3498 | 5:51 PM | ðŸ”µ | Analyzer.pike contains extensive autodoc parsing and type conversion logic | ~350 |
| #3496 | " | ðŸ”µ | Analyzer.pike contains comprehensive autodoc processing with markup conversion | ~296 |
| #3495 | " | ðŸ”µ | analyzer.pike uses String.trim_whites() which is available in Pike 8.0 | ~219 |
| #3492 | " | ðŸ”µ | Analyzer.pike extensively uses Pike 8.0's String.trim_whites() built-in function | ~266 |
| #3482 | 5:50 PM | ðŸ”µ | type-introspector.pike provides runtime type extraction via compilation and reflection | ~267 |
| #3478 | 5:49 PM | ðŸ”µ | Analyzer.pike uses Tools.AutoDoc.DocParser for documentation parsing | ~360 |
| #3477 | " | ðŸ”µ | Analyzer.pike contains uninitialized variable analysis and completion context detection | ~341 |
| #3471 | 5:48 PM | ðŸŸ£ | Pike LSP analyzer supports version-agnostic parsing | ~433 |
| #3465 | " | ðŸ”µ | Discovered String.trim_whites() Available in Pike 8.0 | ~223 |
| #3430 | 5:01 PM | ðŸ”´ | Fixed Pike String.trim() compatibility issue by using built-in String.trim_whites() | ~190 |
| #3427 | " | ðŸ”´ | Replaced Custom trim_string() with Native String.trim_whites() | ~292 |
| #3426 | " | ðŸ”µ | Analyzer.pike Syntax Validation Successful | ~122 |
| #3424 | " | ðŸ”µ | Pike LSP analyzer script implements JSON-RPC protocol | ~373 |
| #3423 | " | ðŸ”µ | Verified trim_string() Usage Throughout analyzer.pike | ~298 |
| #3400 | 4:50 PM | ðŸ”µ | Parser.Pike Native Utilities Integration | ~147 |
| #3396 | 4:48 PM | ðŸ”´ | Fixed syntax error in trim_string() function with cleaner implementation | ~114 |
| #3391 | 4:47 PM | ðŸ”µ | Pike analyzer script syntax verification | ~149 |
| #3388 | " | ðŸ”µ | Analyzer.pike Function Structure Mapped | ~157 |
| #3387 | " | âœ… | Analyzer.pike String.trim() Replaced with trim_string() Function | ~223 |
| #3386 | " | ðŸ”µ | Pike analyzer script cleans up empty fields before returning results | ~209 |
| #3385 | " | ðŸ”´ | Fixed trim_string() Function for Pike 8.0 Compatibility | ~129 |
| #3384 | " | ðŸ”µ | Syntax error found in trim_string() function implementation | ~94 |
| #3381 | 4:46 PM | ðŸ”µ | trim_string helper function added to analyzer.pike | ~301 |
| #3364 | 4:33 PM | ðŸ”´ | Pike 8.0 compatibility: Replaced String.trim() with custom trim_string() | ~260 |
| #3295 | 4:19 PM | ðŸ”µ | type-introspector.pike provides runtime type extraction with LRU caching | ~369 |
| #3263 | 4:17 PM | ðŸ”µ | analyzer.pike implements JSON-RPC server with 12 Pike analysis methods | ~467 |
| #3243 | 4:15 PM | ðŸ”µ | Pike analyzer script uses conditional debug logging with performance optimization | ~270 |
| #3226 | " | ðŸ”µ | Pike analyzer script is comprehensive 3,221-line JSON-RPC server | ~463 |
| #3209 | 4:14 PM | ðŸ”µ | Largest files identified with Pike analyzer script dominating codebase | ~300 |

### Jan 20, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #4485 | 3:15 PM | ðŸ”´ | Fixed VSIX install command filename mismatch | ~216 |
| #4478 | 2:38 PM | ðŸŸ£ | Phase 6 Plan 01 created - End-to-end smoke test | ~539 |
| #4403 | 2:07 PM | âœ… | Pike LSP Extension Rebundled with Latest Modules | ~313 |
| #4347 | 1:54 PM | ðŸ”µ | Correct analyzer method name identified | ~114 |
| #4291 | 1:07 PM | ðŸ”µ | LSP analyzer uses JSON-RPC dispatcher pattern with service container | ~280 |
| #4269 | 12:55 PM | ðŸ”µ | analyzer.pike routes introspect method to Intelligence module not Parser | ~418 |
</claude-mem-context>